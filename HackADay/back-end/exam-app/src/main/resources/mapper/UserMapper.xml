<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.examapp.mapper.UserMapper">


    <sql id="Base_Column_List">
        id,username,password, image_data
    </sql>

    <insert id="register">
        insert into t_user (id, username, password, image_data) values (#{id}, #{username}, #{password}, #{imageData,typeHandler=org.apache.ibatis.type.BlobTypeHandler})
    </insert>
    <select id="getUserByUsername" resultMap="getUserByUsernameWithAuthorities">
        SELECT
            u.id AS id,
            u.username AS username,
            u.password AS password,
            a.id AS authority_id,
            a.authority AS authority
        FROM
            t_user u
                LEFT JOIN
            t_authority a ON u.username = a.username
        WHERE
            u.username = #{username}
    </select>

    <resultMap id="getImageByUsernameResultMap" type="java.util.HashMap">
        <result property="imageData" column="image_data" javaType="byte[]" jdbcType="BLOB" typeHandler="org.apache.ibatis.type.BlobTypeHandler"/>
    </resultMap>

    <!-- Select statement to retrieve the Blob -->
    <select id="getImageByUsername" resultMap="getImageByUsernameResultMap">
        SELECT image_data FROM t_user WHERE username = #{username}
    </select>

    <resultMap id="getUserByUsernameWithAuthorities" type="com.examapp.entity.User">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="username" column="username" jdbcType="VARCHAR"/>
        <result property="password" column="password" jdbcType="CHAR"/>

        <collection property="authorities" ofType="com.examapp.entity.Authority">
            <id property="id" column="authority_id" jdbcType="BIGINT"/>
            <result property="username" column="username" jdbcType="BIGINT"/>
            <result property="authority" column="authority" jdbcType="VARCHAR"/>
        </collection>
    </resultMap>
</mapper>
